# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will build a Java project with Gradle and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle

name: tabbit-deploy
run-name: Running
on:
  push:
    branches: 
      - master
  pull_request:
    branches:
      - develop

jobs:
  build:

    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    # 액션을 사용하여 저장소 코드를 체크아웃
    - uses: actions/checkout@v4 
    
    # 액션을 사용하여 JDK17을 설정
    - name: Set up JDK 17 
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # gradlew 파일에 실행 권한 부여
    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew
    
    # gradle 설정
    - name: Setup Gradle 
      uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5 # v3.1.0
    
    # 테스트를 제외한 빌드 수행
    - name: Build with Gradle Wrapper 
      run: ./gradlew build -x test
    
    # jar파일을 scp를 통해 원격 서버로 복사
    - name: Copy files via SCP 
      uses: appleboy/scp-action@v0.1.1
      with:
        host: ${{ secrets.EC2_HOST }} #ec2 서버
        username: ${{ secrets.EC2_USER }} #ec2 서버 유저
        key: ${{ secrets.EC2_KEY }} #ec2 서버 ssh 키
        source: "build/libs/*.jar"
        target: "/home/ubuntu/tabbit/"
        debug: true 

    # 애플리케이션 중지
    - name: Stop current application
      uses: appleboy/ssh-action@v0.1.1
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          tmux new-session -d -s stop_app 'pkill -f "java -jar" || true'

    # 현재 JAR 파일 백업
    - name: Backup current JAR
      uses: appleboy/ssh-action@v0.1.1
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          tmux new-session -d -s backup_jar 'mv /home/ubuntu/tabbit/build/libs/app.jar /home/ubuntu/tabbit/build/libs/app_backup.jar || true'

    # 새 JAR 파일 배포
    - name: Deploy new JAR
      uses: appleboy/ssh-action@v0.1.1
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          tmux new-session -d -s deploy_jar 'mv /home/ubuntu/tabbit/build/libs/tabbit.jar /home/ubuntu/tabbit/build/libs/app.jar'

    # 새로운 애플리케이션 시작
    - name: Start new application
      uses: appleboy/ssh-action@v0.1.1
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          tmux new-session -d -s start_app 'mkdir -p /home/ubuntu/tabbit/log && nohup java -jar /home/ubuntu/tabbit/build/libs/app.jar --spring.config.location=/home/ubuntu/tabbit/application.yaml > /home/ubuntu/tabbit/log/log.txt 2>&1 &'

    # 오래된 백업 파일 삭제
    - name: Cleanup old backups
      uses: appleboy/ssh-action@v0.1.1
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          tmux new-session -d -s cleanup 'find /home/ubuntu/tabbit/build/libs/ -name "app_backup.jar" -mtime +1 -exec rm {} \;'
